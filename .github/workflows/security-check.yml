name: CI ‚Äî Security & Build

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run security checks daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  security-and-build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js (with pnpm cache)
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Verify pnpm installation
        run: |
          echo "pnpm version: $(pnpm --version)"
          echo "pnpm location: $(which pnpm)"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Setup PHP for Composer audit
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4'
          extensions: mbstring, xml, ctype, iconv, intl, pdo, pdo_sqlite, dom, curl, libxml, simplexml

      - name: Install Composer dependencies
        run: |
          cd api
          composer install --no-dev --prefer-dist

      - name: Run PHP Composer security audit
        run: |
          cd api
          echo "üîç Running Composer security audit..."
          
          # Run composer audit and capture output (don't fail on exit code)
          composer audit --format=json > composer-audit.json || true
          
          # Check if there are actual advisories in the JSON
          ADVISORY_COUNT=$(cat composer-audit.json | grep -c '"cve"' || echo "0")
          
          echo "üìä PHP Dependencies audit:"
          echo "   Security advisories found: $ADVISORY_COUNT"
          
          if [ "$ADVISORY_COUNT" -gt "0" ]; then
            echo "‚ùå CRITICAL: Composer audit found $ADVISORY_COUNT security vulnerabilities!"
            echo "üìã Audit details:"
            cat composer-audit.json
            exit 1
          else
            echo "‚úÖ Composer audit passed - no security vulnerabilities found"
          fi

      - name: Run pnpm security audit
        run: |
          echo "üîç Running pnpm security audit..."
          
          # Run audit and capture output (don't fail on exit code)
          pnpm audit --json > pnpm-audit.json || true
          
          # Parse JSON to check for actual critical vulnerabilities
          CRITICAL_COUNT=$(cat pnpm-audit.json | grep -o '"critical":[0-9]*' | grep -o '[0-9]*' || echo "0")
          HIGH_COUNT=$(cat pnpm-audit.json | grep -o '"high":[0-9]*' | grep -o '[0-9]*' || echo "0")
          
          echo "üìä Vulnerability summary:"
          echo "   Critical: $CRITICAL_COUNT"
          echo "   High: $HIGH_COUNT"
          
          # Only fail if there are actual critical vulnerabilities
          if [ "$CRITICAL_COUNT" -gt "0" ]; then
            echo "‚ùå CRITICAL: pnpm audit found $CRITICAL_COUNT critical vulnerabilities!"
            echo "üìã Audit details:"
            cat pnpm-audit.json
            exit 1
          elif [ "$HIGH_COUNT" -gt "0" ]; then
            echo "‚ö†Ô∏è WARNING: pnpm audit found $HIGH_COUNT high severity vulnerabilities"
            echo "üìã Audit details:"
            cat pnpm-audit.json
            # Continue without failing for high severity
          else
            echo "‚úÖ pnpm audit passed - no critical vulnerabilities found"
          fi

      - name: Run linter (if defined)
        run: |
          if pnpm -s run | grep -q "lint"; then
            pnpm lint
          else
            echo "‚ö†Ô∏è No lint script defined, skipping lint step"
          fi

      - name: Build project (if defined)
        run: |
          if pnpm -s run | grep -q "build"; then
            pnpm build
          else
            echo "‚ö†Ô∏è No build script defined, skipping build step"
          fi

      - name: Security scan summary
        run: |
          echo "üîí Security & Build job complete"
          echo "‚úÖ If this job passed, basic CI checks succeeded"
