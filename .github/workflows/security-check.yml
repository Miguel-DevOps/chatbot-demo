name: CI â€” Security & Build

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run security checks daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  security-and-build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js (with pnpm cache)
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: latest

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Setup PHP for Composer audit
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4'
          extensions: mbstring, xml, ctype, iconv, intl, pdo, pdo_sqlite, dom, curl, libxml, simplexml

      - name: Install Composer dependencies
        run: |
          cd api
          composer install --no-dev --prefer-dist

      - name: Run PHP Composer security audit
        run: |
          cd api
          echo "ğŸ” Running Composer security audit..."
          composer audit --format=json > composer-audit.json || COMPOSER_EXIT=$?
          
          # Check if there are any security advisories
          if [ "$COMPOSER_EXIT" != "0" ]; then
            echo "âŒ CRITICAL: Composer audit found security vulnerabilities!"
            cat composer-audit.json
            exit 1
          else
            echo "âœ… Composer audit passed - no security vulnerabilities found"
          fi

      - name: Run pnpm security audit
        run: |
          echo "ğŸ” Running pnpm security audit..."
          
          # Run audit and capture output
          pnpm audit --audit-level critical --json > pnpm-audit.json || PNPM_EXIT=$?
          
          # Check for critical vulnerabilities only
          if [ "$PNPM_EXIT" != "0" ]; then
            echo "âŒ CRITICAL: pnpm audit found critical vulnerabilities!"
            echo "ğŸ“‹ Audit details:"
            cat pnpm-audit.json
            exit 1
          else
            echo "âœ… pnpm audit passed - no critical vulnerabilities found"
          fi

      - name: Run linter (if defined)
        run: |
          if pnpm -s run | grep -q "lint"; then
            pnpm lint
          else
            echo "âš ï¸ No lint script defined, skipping lint step"
          fi

      - name: Build project (if defined)
        run: |
          if pnpm -s run | grep -q "build"; then
            pnpm build
          else
            echo "âš ï¸ No build script defined, skipping build step"
          fi

      - name: Security scan summary
        run: |
          echo "ğŸ”’ Security & Build job complete"
          echo "âœ… If this job passed, basic CI checks succeeded"
