services:
  api:
    build:
      context: ./api
      dockerfile: Dockerfile
      target: production # Use final and optimized Dockerfile stage
    volumes: # NO source code volumes in production
      - api-logs:/var/www/html/logs
      - api-storage:/var/www/html/storage
    environment:
      - APP_ENV=production
      - LOG_LEVEL=info
      - OTEL_TRACES_ENABLED=true
    ports: [] # Don't expose ports directly, Nginx is the proxy
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,size=100m
    cap_drop:
      - ALL
    deploy:
      resources:
        limits: { memory: 512M, cpus: '1.0' }
        reservations: { memory: 256M, cpus: '0.5' }

  redis:
    ports: [] # Don't expose Redis to outside in production
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,size=10m
    cap_drop:
      - ALL

volumes:
  api-logs:
  api-storage: