# Docker Compose configuration for CI/CD Testing
# This file maintains production parity while providing testing-specific configurations

services:
  # PHP-FPM API service for testing
  api:
    build:
      context: ./api
      dockerfile: Dockerfile
      target: dependencies  # Use dependencies stage which has Composer for testing
    user: "1000:1000"  # Same user as production
    environment:
      - APP_ENV=testing
      - LOG_LEVEL=debug
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=
      - REDIS_DATABASE=0
      # OpenTelemetry configuration (same as production)
      - OTEL_SERVICE_NAME=chatbot-demo-api-test
      - OTEL_SERVICE_VERSION=1.0.0
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4318
      - OTEL_TRACES_ENABLED=false  # Disabled for testing
      - OTEL_METRICS_ENABLED=false # Disabled for testing
      - OTEL_LOGS_ENABLED=false    # Disabled for testing
    volumes:
      - api-logs:/var/www/html/logs
      - api-storage:/var/www/html/storage
    depends_on:
      - redis
    networks:
      - chatbot-network
    # Remove security hardening for CI environment to allow test execution
    # security_opt:
    #   - no-new-privileges:true
    # read_only: false  # Allow writes for test results
    tmpfs:
      - /tmp:noexec,nosuid,size=100m
      - /var/tmp:noexec,nosuid,size=50m
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETGID
      - SETUID
    # Override default command to keep container running for testing
    command: ["tail", "-f", "/dev/null"]
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '1.0'
        reservations:
          memory: 256M
          cpus: '0.5'

  # Redis cache service (same as production)
  redis:
    image: redis:7-alpine
    user: "999:999"  # Redis user
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru --protected-mode no
    volumes:
      - redis-data:/data
    networks:
      - chatbot-network
    # Same security hardening as production
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,size=10m
    cap_drop:
      - ALL
    cap_add:
      - SETGID
      - SETUID
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.5'
        reservations:
          memory: 128M
          cpus: '0.25'

volumes:
  redis-data:
    driver: local
  api-logs:
    driver: local
  api-storage:
    driver: local

networks:
  chatbot-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16